<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org/"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layouts/breadflow_layout}"
      layout:fragment="Content">
<head>
    <meta charset="UTF-8">
    <title>제품목록</title>
    <style>
        .clickable {
            cursor: pointer;
            color: #0d6efd;
        }
        .clickable:hover {
            text-decoration: underline;
        }
        /* Remove sort arrows */
        th.datatable::after,
        th.datatable::before,
        th.table-plus::after,
        th.table-plus::before {
            display: none !important;
        }
        /* Search styling */
        .search-container {
            display: flex;
            gap: 8px;
        }
        .search-input {
            padding: 4px 12px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 14px;
        }
        .search-button {
            padding: 4px 16px;
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
        }
        .search-button:hover {
            background-color: #5a6268;
        }
    </style>
</head>
<body>
    <h2 class="mb-4">제품목록</h2>
    <div class="d-flex gap-3 mb-3 " style="margin-left: -0.75rem;">
        <div class="col-md-3">
            <div class="form-group">
                <select id="categorylist"
                	class="selectpicker form-control form-control-sm" data-size="5"
                    data-style="btn-outline-secondary btn-sm">
                    <option value="">선택</option>
                    <th:block th:each="cate : ${category}">
                    	<option th:value="${cate.sub}" th:utext="${cate.sub}"></option>
                    </th:block>
                </select>
            </div>
        </div>
        <div class="col-md-3">
            <div class="form-group">
                <select id="subList"
                	class="selectpicker form-control form-control-sm" data-size="5"
                    data-style="btn-outline-secondary btn-sm" multiple data-max-options="3">
                </select>
            </div>
        </div>
    </div>
	<div class="gap-2 mb-3">
	        <button type="submit" class="btn btn-primary btn-sm" th:onclick="|location.href='@{/product/Insert}'|">등록</button>
	        <button type="button" class="btn btn-danger btn-sm" onclick="checkBoxDeleteClick()">삭제</button>
    </div>
    
    <!-- 데이터 테이블 시작 -->
    <div class="pb-20">
        <table class="data-table table stripe hover wrap" id="productTable">
        
            <thead>
                <tr style="text-align : center;">
                	<th class="datatable">
	                	<div class="dt-checkbox">
	                            <input type="checkbox" name="select_all" value="1" id="example-select-all">
	                            <span class="dt-checkbox-lable"></span>
	                    </div>
                	</th>
                    <th class="table-plus">제품코드</th>
                    <th class="datatable">제품명</th>
                    <th class="datatable">소비기한</th>
                    <th class="datatable">매입가</th>
                    <th class="datatable">판매가</th>
                    <th class="datatable">규격</th>
                </tr>
            </thead>
            <tbody>

                <th:block th:each="info : ${products}">
                    <tr th:data-sub="${info.sub}" th:data-major="${info.major}" style="text-align : center;">
                    	<td>
                    		<div class="dt-checkbox">
                                <input type="checkbox" name="checkProductCode">
                                <span class="dt-checkbox-lable"></span>
                        	</div>
                    	</td>

                        <td class="clickable" th:onclick="showProductDetail([[${info.productCode}]])">[[${info.productCode}]]</td>
                        <td class="clickable" th:onclick="showProductDetail([[${info.productCode}]])">[[${info.productName}]]</td>
                        <td>[[${info.expirationDeadline}]]일</td>
                        <td class="purchasePrice" th:text="|${#numbers.formatInteger(info.purchasePrice, 0, 'COMMA')}원|">[[${info.purchasePrice}]]</td>
                        <td class="salePrice" th:text="|${#numbers.formatInteger(info.salePrice, 0, 'COMMA')}원|">[[${info.salePrice}]]</td>
                        <td>[[${info.standard}]]</td>
                    </tr>
                </th:block>
            </tbody>
        </table>
    </div>
	
    <!-- 제품상세보기 모달창 -->
	<div class="modal fade" id="productDetailModal" tabindex="-1" role="dialog" aria-labelledby="productDetailModalLabel" aria-hidden="true">
	    <div class="modal-dialog modal-lg modal-dialog-centered">
	        <div class="modal-content">
	            <div class="modal-header">
	                <h4 class="modal-title" id="productDetailModalLabel">제품 상세정보</h4>
	                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
	            </div>
	            <div class="modal-body">
	                <div class="row">
	                    <div class="col-md-4 text-center mb-3">
	                        <img id="productImage" src="" alt="" class="img-fluid" style="max-width: 200px; max-height: 200px; object-fit: cover;">
	                    </div>
	                    <div class="col-md-8">
	                        <div class="row row-cols-4">
	                            <div class="col mb-3">
	                                    <strong>제품코드</strong>
	                                <div class="border rounded p-2 h-80">
	                                    <div id="productCode"></div>
	                                </div>
	                            </div>
	                            <div class="col mb-3">
	                                    <strong>제품명</strong>
	                                <div class="border rounded p-2 h-80">
	                                    <div id="productName"></div>
	                                </div>
	                            </div>
	                            <div class="col mb-3">
	                                    <strong>소비기한</strong>
	                                <div class="border rounded p-2 h-80">
	                                    <div id="expirationDeadline"></div>
	                                </div>
	                            </div>
	                            <div class="col mb-3">
	                                    <strong>규격</strong>
	                                <div class="border rounded p-2 h-80">
	                                    <div id="standard"></div>
	                                </div>
	                            </div>
	                            <div class="col mb-3">
	                                    <strong>매입가</strong>
	                                <div class="border rounded p-2 h-80">
	                                    <div id="purchasePrice"></div>
	                                </div>
	                            </div>
	                            <div class="col mb-3">
	                                    <strong>판매가</strong>
	                                <div class="border rounded p-2 h-80">
	                                    <div id="salePrice"></div>
	                                </div>
	                            </div>
	                            <div class="col mb-3">
	                                    <strong>안전재고수량</strong>
	                                <div class="border rounded p-2 h-80">
	                                    <div id="safeStockQuantity"></div>
	                                </div>
	                            </div>
	                            <div class="col mb-3">
	                                    <strong>생산지</strong>
	                                <div class="border rounded p-2 h-80">
	                                    <div id="proplace"></div>
	                                </div>
	                            </div>
	                            <div class="col mb-3">
	                                    <strong>단위</strong>
	                                <div class="border rounded p-2 h-80">
	                                    <div id="unit"></div>
	                                </div>
	                            </div>
	                            <div class="col mb-3">
	                                    <strong>대분류</strong>
	                                <div class="border rounded p-2 h-80">
	                                    <div id="major"></div>
	                                </div>
	                            </div>
	                            <div class="col mb-3">
	                                    <strong>소분류</strong>
	                                <div class="border rounded p-2 h-80">
	                                    <div id="sub"></div>
	                                </div>
	                            </div>
	                            <div class="col mb-3">
	                                    <strong>양</strong>
	                                <div class="border rounded p-2 h-80">
	                                    <div id="amount"></div>
	                                </div>
	                            </div>
	                            <input type="hidden" id="productCodes"/>
	                        </div>
	                    </div>
	                </div>
	            </div>
	            <div class="modal-footer">
	                <button type="submit" class="btn btn-primary" data-dismiss="modal" onclick="updatePage()">수정</button>
	                <button type="button" class="btn btn-secondary" data-dismiss="modal">닫기</button>
	            </div>
	        </div>
	    </div>
	</div>


	<script>
	// 가격에 , 찍기
	  
    
    // 현제 모달창에서 수정하기 기능 추가하여 넣기 이미지수정하기 까지 
		function showProductDetail(productCode) {
		    $.ajax({
		        url: '/productListAll/' + productCode,
		        method: 'GET',
		        success: function(product) {
		        	
		            document.getElementById('productImage').src = '/imgs/' + product.productImage;
		            document.getElementById('productImage').alt = product.productName;
		            document.getElementById('productCode').textContent = product.productCode;
		            document.getElementById('productName').textContent = product.productName;
		            document.getElementById('expirationDeadline').textContent = product.expirationDeadline + '일';
		            document.getElementById('standard').textContent = product.standard;
		            document.getElementById('purchasePrice').textContent = product.purchasePrice + '원';
		            document.getElementById('salePrice').textContent = product.salePrice + '원';
		            document.getElementById('safeStockQuantity').textContent = product.safeStockQuantity;
		            document.getElementById('proplace').textContent = product.proplace;
		            document.getElementById('unit').textContent = product.unit;
		            document.getElementById('major').textContent = product.major;
		            document.getElementById('sub').textContent = product.sub;
		            document.getElementById('amount').textContent = product.amount + product.unit;
		            document.getElementById('productCodes').value = product.productCode;
		            $('#productDetailModal').modal('show');
		        },
		        error: function(xhr, status, error) {
		            alert('제품 정보를 불러오는데 실패했습니다.');
		        }
		    });
		}
	
        let myTable ;
        // 모달 close handlers
        $(document).ready(function() {
            // Close on X button
            $('.close').on('click', function() {
                $('#productDetailModal').modal('hide');
            });
            
            // Close on close button
            $('.btn-secondary[data-dismiss="modal"]').on('click', function() {
                $('#productDetailModal').modal('hide');
            });
            
            // Close on outside click
            $('#productDetailModal').on('click', function(e) {
                if ($(e.target).hasClass('modal')) {
                    $('#productDetailModal').modal('hide');
                }
            });
         // 현제모달이 외부클릭시 닫히게끔하는 기능 -- x 버튼클릭시 닫기가능하게 바꾸기 수정버튼 클릭시 등록하면으로 전환 + 데이터넘겨서 등록화면에서 수정가능하게 만들기까지.
            
            

           // Initialize DataTable without sorting 데이터테이블 사용 설정
           myTable = $('.data-table').DataTable({
                "ordering": false,
                "info": false,         
                "lengthChange": false ,
                language: {
                    search: "검색:",
                    paginate: {
                        first: "처음",
                        last: "마지막",
                        next: "다음",
                        previous: "이전"
                    }                    
                }
            });
            
            
           var mySelect = $('#categorylist');
           var mySelect2 = $('#subList');
           
           $('#categorylist').on('changed.bs.select', function (e, clickedIndex, isSelected, previousValue) {
     			const category = e.target.options[clickedIndex].value
     			mySelect2.empty()
     			
     	        	// ajax
     	        	fetch("category/subList?major="+category)
     	        	.then(response => response.json())
     	        	.then(response => {
     	        		
     	        		for(item of response){
     	        			mySelect2.append(`<option>${item.sub}</option>`)
     	        		}
     	        		mySelect2.selectpicker('refresh');
     	        	})
     	        myTable.draw();
     	   });
   		
           $('#subList').on('changed.bs.select', function (e, clickedIndex, isSelected, previousValue) {
     			myTable.draw()
           });
           
        });
        
        
        // 체크박스 체크후 삭제버튼 클릭시 해당품목을 삭제하시겠습니까? 작은모달창 질문후 예 버튼 클릭시 해당 품목삭제기능 
        $(document).ready(function() {
		    // 전체 선택 체크박스 클릭 시
		    $('#example-select-all').on('click', function() {
		        var isChecked = $(this).prop('checked');  // 체크 여부 확인
		        // tbody의 모든 체크박스에 동일한 상태 적용
		        $('#productTable tbody input[type="checkbox"]').prop('checked', isChecked);
		    });
		
		    // 개별 체크박스 클릭 시
		    $('#productTable tbody').on('change', 'input[type="checkbox"]', function() {
		        // 모든 체크박스가 선택되었으면 thead의 체크박스를 체크
		        var totalCheckboxes = $('#productTable tbody input[type="checkbox"]').length;
		        var checkedCheckboxes = $('#productTable tbody input[type="checkbox"]:checked').length;
		
		        // 전체 체크박스가 다 선택되었으면 thead 체크박스를 체크
		        if (totalCheckboxes === checkedCheckboxes) {
		            $('#example-select-all').prop('checked', true);
		        } else {
		            // 하나라도 선택되지 않으면 thead 체크박스를 해제
		            $('#example-select-all').prop('checked', false);
		        }
		    });
            
		    
		    
		    
		});
        
      //체크박스 클릭시 삭제하기 기능 전체삭제까지
		function checkBoxDeleteClick(){
    	  	let delcheck = confirm("삭제하시겠습니까?")
    	  	if(delcheck == false){
    	  		return
    	  	}
        	var checkBoxArr = [];
        	$("[name='checkProductCode']:checked").each(function(){
        		checkBoxArr.push($(this).closest('td').next().text()); // 체크된 항목 값 배열에 push
        	})
        	$.ajax({
        		url : "product",
        		type : "DELETE",
        		contentType : 'application/json',
        		data : JSON.stringify(checkBoxArr),
        		success : function(result){
        			location.reload(true);
        		},
        		error : function(xhr, status, error){
        			alert("삭제에 실패했습니다.");
        		}
        		
        	});
        	
        }			
        
        // 카테고리 선택시 테이블에 카테고리 선택항목만 열람
        $.fn.dataTable.ext.search.push(function(setting, data, dataIndex){
        	
        	var trNode = setting.aoData[dataIndex].nTr;
            var attr1 = trNode.getAttribute("data-major");
            var attr2 = trNode.getAttribute("data-sub");
        	
        	var val1 = $('#categorylist').val();
        	var val2 = [];
        	
        	$('#subList option:selected').each((idx, element) => val2.push(element.value))
        	console.log(attr2, val2)
        	if((val1 === "" || val1 === attr1) &&
        	 (val2.length == 0 || val2.includes(attr2))){
        		return true;
        	}
        	return false;
        });
        	
        
        function updatePage() {
        	const productCode = $('#productCodes').val();
        	
        	location.href = "product/Update?productCode=" + productCode;
        }
        
        		
    </script>
</body>
</html>
<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org/"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/layouts/breadflow_layout}"
	layout:fragment="Content">
<head>
<meta charset="UTF-8">
<title>Calendar with Sales Data</title>
    <style>
		body {
		    font-family: Arial, sans-serif;
		    display: flex;
		    justify-content: center;
		    align-items: center;
		    height: 100vh;
		    margin: 0;
		    background-color: #f0f0f0;
		}
		
		.calendar {
		    background-color: white;
		    border-radius: 10px;
		    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
		    padding: 20px;
		    width: 100%;
		    height: 800px;
		    display: flex;
		    flex-direction: column;
		}
		
		.calendar-header {
		    display: flex;
		    justify-content: space-between;
		    align-items: center;
		    margin-bottom: 20px;
		}
		
		button {
		    background-color: #f0f0f0;
		    border: none;
		    color: black;
		    padding: 10px 15px;
		    text-align: center;
		    text-decoration: none;
		    display: inline-block;
		    font-size: 16px;
		    margin: 4px 2px;
		    cursor: pointer;
		    border-radius: 5px;
		}
		
		table {
		    border-collapse: collapse;
		    width: 100%;
		    height: calc(100% - 60px);
		}
		
		th, td {
		    border: 1px solid #ddd;
		    padding: 8px;
		    text-align: right;
		    vertical-align: top;
		}
		
		th {
		    background-color: #f2f2f2;
		    text-align: center;
		}
		
		td {
		    height: 15%;
		}
		
		.date {
		    font-weight: bold;
		    margin-bottom: 5px;
		}
		
		.sunday {
		    color: red;
		}
		
		.saturday {
		    color: blue;
		}
		
		#totalRow td {
		    text-align: center;
		    font-weight: bold;
		}
    </style>
</head>
<body>
    <div class="calendar">
        <div class="calendar-header">
            <button id="prevMonth">&lt;</button>
            <h2 id="currentMonth"></h2>
            <button id="nextMonth">&gt;</button>
        </div>
        <table id="calendarTable">
            <thead>
                <tr>
                    <th>일</th>
                    <th>월</th>
                    <th>화</th>
                    <th>수</th>
                    <th>목</th>
                    <th>금</th>
                    <th>토</th>
                    <th style="width:160px;">계</th>
                </tr>
            </thead>
            <tbody id="calendarBody"></tbody>
            <tfoot>
                <tr id="totalRow"></tr>
            </tfoot>
        </table>
    </div>
    <script>
	    let currentDate = new Date();
		loadDaySale();
	    updateCalendar();
		
	    function updateCalendar() {
	        const monthNames = ["1월", "2월", "3월", "4월", "5월", "6월",
	            "7월", "8월", "9월", "10월", "11월", "12월"];
	        document.getElementById('currentMonth').textContent = `${currentDate.getFullYear()}-${monthNames[currentDate.getMonth()]}`;
	        const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
	        const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1 , 0);
	
	        const calendarBody = document.getElementById('calendarBody');
	        calendarBody.innerHTML = '';
	
	        let date = 1;
	        let dayTotals = [0, 0, 0, 0, 0, 0, 0]; // 요일별 매출 합계
	        let monthTotal = 0;
	        
	        for (let i = 0; i < 6; i++) {
	            const row = document.createElement('tr');
	            for (let j = 0; j < 8; j++) {
	                const cell = document.createElement('td');
	                if (j === 7) {
	                    // 주별 합계 표시
	                    cell.textContent = dayTotals.reduce((a, b) => a + b, 0).toLocaleString() + "원"; // 주별 합계
	                    cell.style.color = "green";
	                    cell.style.textAlign = "center";
	                    cell.style.verticalAlign = "middle";
	                } else if (i === 0 && j < firstDay.getDay()) {
	                    // 빈 셀 (첫 번째 주의 첫날 이전)
	                } else if (date > lastDay.getDate()) {
	                    // 빈 셀 (달의 마지막 날 이후)
	                } else {
	                    const dateDiv = document.createElement('div');
	                    dateDiv.textContent = date;
	                    dateDiv.className = 'date';
	                    dateDiv.dataset.date = currentDate.getFullYear() + (currentDate.getMonth()+1).toString().padStart(2, "0") + date.toString().padStart(2,"0");
	                    
	                    if (j === 0) dateDiv.classList.add('sunday');
	                    if (j === 6) dateDiv.classList.add('saturday');
	                    cell.appendChild(dateDiv);
	                    date++;
	                }
	                row.appendChild(cell);
	            }
	            calendarBody.appendChild(row);
	            if (date > lastDay.getDate()) {
	                break;
	            }
	        }

	        // 총합 업데이트
	        const totalRow = document.getElementById('totalRow');
	        totalRow.innerHTML = '';
	        const days = ['일요일(합)', '월요일(합)', '화요일(합)', '수요일(합)', '목요일(합)', '금요일(합)', '토요일(합)', '총계']; 
	        for (let i = 0; i < 8; i++) {
	            const cell = document.createElement('td');
	            cell.textContent = `${days[i]}\n${(i < 7 ? dayTotals[i] : monthTotal).toLocaleString()}원`; 
	            totalRow.appendChild(cell);
	        }
	    }
	
	    document.getElementById('prevMonth').addEventListener('click', () => {
	        currentDate.setMonth(currentDate.getMonth() - 1);
	        updateCalendar();
	        loadDaySale();
	    });

	    document.getElementById('nextMonth').addEventListener('click', () => {
	        currentDate.setMonth(currentDate.getMonth() + 1);
	        updateCalendar();
	        loadDaySale();
	    });

	    function loadDaySale(saDate) {
	        let url = `/daySale?saDate=${saDate}`;
	        
	        fetch(url, {
	            method: "POST"
	        })
	        .then(response => response.json())
	        .then(data => {
	            console.log(data);  // 서버에서 받은 데이터를 콘솔로 출력하여 확인
	            const cells = document.querySelectorAll('.date');
	            const dayTotals = [0, 0, 0, 0, 0, 0, 0]; // 요일별 매출
	            let monthTotal = 0;

	            // 매출 데이터로 캘린더를 업데이트
	            cells.forEach(cel => {
	                const date = cel.dataset.date;
	                const mat = data.find(ele => ele.salesDate == date);

	                if (mat) {
	                    const sales = mat.daySales;
	                    const saleDiv = document.createElement('div');
	                    saleDiv.textContent = sales.toLocaleString() + '원'; 
	                    cel.appendChild(saleDiv);

	                    // 요일별 합계 계산
	                    const dayOfWeek = new Date(date).getDay();
	                    dayTotals[dayOfWeek] += sales;
	                    monthTotal += sales;
	                }
	            });

	            // 총합 업데이트
	            const totalRow = document.getElementById('totalRow');
	            totalRow.innerHTML = '';
	            const days = ['일요일(합)', '월요일(합)', '화요일(합)', '수요일(합)', '목요일(합)', '금요일(합)', '토요일(합)', '총계']; 
	            for (let i = 0; i < 8; i++) {
	                const cell = document.createElement('td');
	                cell.textContent = `${days[i]}\n${(i < 7 ? dayTotals[i] : monthTotal).toLocaleString()}원`; 
	                totalRow.appendChild(cell);
	            }
	        })
	        .catch(error => {
	            console.error("Error fetching sales data:", error);
	        });
	    }
	    
		$('.calendar-header button').on('click', function(){
		    if($(this).attr("id") == 'prevMonth'){
		    	let day = $(this).next().text().substring(5,7).includes('월') ? "0" + $(this).next().text().substring(5,6) : $(this).next().text().substring(5,7);
		    	let prev = $(this).next().text().substring(0,4) + day;
		    	loadDaySale(prev);
		    }
		    else{
		    	let day = $(this).prev().text().substring(5,7).includes('월') ? "0" + $(this).prev().text().substring(5,6) : $(this).prev().text().substring(5,7);
		    	let next = $(this).prev().text().substring(0,4) + day;
		    	loadDaySale(next);
		    }
		})

    </script>
</body>
</html>

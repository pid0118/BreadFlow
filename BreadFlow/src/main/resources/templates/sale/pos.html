<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org/"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/layouts/breadflow_layout}"
	layout:fragment="Content">
<head>
<meta charset="UTF-8">
<title></title>
<style>
body {
	font-family: Arial, sans-serif;
	margin: 0;
	padding: 0;
	background-color: #f0f0f0;
}

.container {
	display: flex;
	max-width: 100%;
	height: 100%;
	margin: 0 auto;
	background-color: #fff;
	box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
}

.left-panel {
	flex: 2;
	border-right: 1px solid #ddd;
}

.right-panel {
	flex: 1;
	width: 400px;
	padding: 20px;
	margin: 10px;
	background-color: #f9f9f9;
}

header {
	display: flex;
	justify-content: space-between;
	padding: 10px;
	background-color: #4a4a4a;
	color: white;
}

nav {
	display: flex;
	overflow-x: auto;
	background-color: #f0f0f0;
	padding: 10px 5px;
}

.nav-button {
	border: none;
	background: none;
	padding: 5px 10px;
	margin: 0 5px;
	white-space: nowrap;
}

.nav-button.active {
	font-weight: bold;
	border-bottom: 2px solid #000;
}

.menu-grid {
	display: grid;
	grid-template-columns: repeat(4, 1fr);
	grid-template-rows: repeat(5, 1fr);
	height: 470px;
	gap: 10px;
	padding: 10px;
}

.menu-item {
	background-color: #fff;
	border: 1px solid #ddd;
	height: 82px;
	padding: 10px;
	text-align: center;
	cursor: pointer;
	transition: background-color 0.3s ease;
}

.menu-item:hover {
	background-color: #f0f0f0;
}

.item-name {
	font-weight: bold;
	margin-bottom: 5px;
}

.item-price {
	color: #666;
}

.hot {
	background-color: #ffebee;
}

.ice {
	background-color: #e3f2fd;
}

.caramel-frost {
	background-color: #e1f5fe;
}

.black-bean {
	background-color: #e8f5e9;
}

.green-tea {
	background-color: #f1f8e9;
}

.grapefruit {
	background-color: #fff3e0;
}

.action-buttons {
	display: flex;
	justify-content: flex-end;
	padding: 10px;
	background-color: #f0f0f0;
}

.action-button {
	border: none;
	background: none;
	margin: 0 5px;
	font-size:24px;
}

footer {
	background-color: #f0f0f0;
	height: 130px;
	padding: 10px;
}

.footer-buttons {
	display: flex;
	justify-content: space-between;
	margin-bottom: 10px;
}

.footer-buttons button {
	border: 1px solid #ddd;
	background-color: #fff;
	padding: 5px 10px;
	float: left;
}

.footer-actions {
	display: flex;
	justify-content: space-between;
	margin-bottom: 10px;
}

.prev-button, .next-button {
	border: 1px solid #ddd;
	background-color: #fff;
	padding: 5px 10px;
}

.submit-button {
	background-color: #4a4a4a;
	color: white;
	border: none;
	padding: 5px 15px;
}

.total {
	text-align: right;
	font-weight: bold;
}

#selected-items {
	margin-top: 20px;
	overflow-y: auto;
	height: 600px;
}

.selected-item {
	display: flex;
	justify-content: space-between;
	align-items: center;
	margin-bottom: 10px;
	padding: 10px;
	background-color: #fff;
	border: 1px solid #ddd;
}

.item-controls {
	display: flex;
	align-items: center;
}

.item-controls button {
	margin: 0 5px;
	padding: 5px 10px;
	background-color: #f0f0f0;
	border: 1px solid #ddd;
	cursor: pointer;
}

.total-price {
	margin-top: 20px;
	font-weight: bold;
	font-size: 1.2em;
}

.details-button {
	background-color: #f1f1f1;
	color: black;
}

.button-container {
	display: flex;
	justify-content: space-between;
	margin-top: 10px;
	width: 100%;
}
.btn.amount {
    font-size: 24px;  /* 글씨 크기를 24px로 설정 */
    padding: 5px 10px;
    background-color: rgb(228, 240, 237);
    border: 1px solid #ddd;
    cursor: pointer;
}

.btn.amount:hover {
    background-color: #ddd;  /* hover 시 배경색 변경 */
}
.modal {
    display: none;
    position: fixed;
    z-index: 1;
    left: 0;
    top: 0;
    width: 100%; 
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.5);
}

.modal-content {
    background-color: #fff;
    margin: 15% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 60%; /* 모달의 너비 */
}

.close-button {
    color: #aaa;
    font-size: 28px;
    font-weight: bold;
    position: absolute;
    top: 10px;
    right: 25px;
}

.close-button:hover,
.close-button:focus {
    color: black;
    text-decoration: none;
    cursor: pointer;
}

</style>
</head>
<body>
	<div class="container">
		<div class="left-panel">
			<header>
				<span th:text="${#dates.format(#dates.createNow(), 'MM월 dd일 (EEE) a hh:mm')}"></span>
				<div class="header-right"></div>
			</header>
			<nav class="menu-type">
				<button class="nav-button active" data-category="">전체메뉴</button>
				<button class="nav-button" data-category="브레드">빵</button>
				<button class="nav-button" data-category="쿠키">쿠키</button>
				<button class="nav-button" data-category="샌드위치">샌드위치</button>
				<button class="nav-button" data-category="커피&음료">커피&음료</button>
			</nav>
			<div class="menu-grid"></div>
			<div class="action-buttons">
				<span class="item-count">0개</span>
			</div>
			<footer>
				<div class="footer-actions">
					<div class="pagination"></div>
					<div class="total"></div>
					<button id="salesSub" class="submit-button">마감 정산</button>
				</div>
			</footer>
		</div>
		<div class="right-panel">
			<h3>선택된 메뉴</h3>
			<ul id="selected-items" class="list-group mb-3">
			</ul>
	
			<div class="total-price">
				총 금액: <span id="total-price">0</span>원
			</div>
			<div class="button-container">
				<button type="submit" id="menuSub" class="submit-button">주문</button>
				<button class="details-button">상세내역</button>
			</div>
		</div>
		<div id="detailsModal" class="modal">
		    <div class="modal-content">
		        <span class="close-button">&times;</span>
		        <h2>상세내역</h2>
		        <table style="border:1px solid;">
		       		<thead>
		       			<tr>
		       				<th>시간</th>
		       				<th>제품명</th>
		       				<th>수량</th>
		       				<th>합계</th>
		       			</tr>
		       		</thead>
		       		<tbody>
		       			<tr th:each="list : ${dList}">
		       				<td th:text="${list.saleDate}"></td>
		       				<td th:text="${list.productCode}"></td>
		       				<td th:text="${list.quantity}"></td>
		       				<td th:text="${list.salePrice}"></td>
		       			</tr>
		       		</tbody>
		       	</table>
		    </div>
		</div>
	</div>
	<script>
		let selectedMenu = []; // 메뉴를 담을 배열
		let itemGrid = document.querySelector(".menu-grid");
		let selectItemList = document.querySelector("#selected-items");
		let totalPriceElem = document.querySelector(".total-price");
		let itemCountElem = document.querySelector('.item-count');
		let disItemCnt = 0; // 현재 보여지는 아이템 갯수
		let curPage = 1; // 현재 페이지
		let itemsPage = 20; // 한 페이지 아이템 수
		let totalPages = 1; // 전체 페이지 수
		let menuData = []; // 메뉴데이터
		
		// 메뉴 탭 AJAX
		loadMenu();

		// AJAX

		document.addEventListener('DOMContentLoaded', function(){

			// 카테고리 버튼 클릭 시 메뉴를 AJAX로 로드
			let buttons = document.querySelectorAll('.nav-button');
			buttons.forEach(button => {
				button.addEventListener('click', function() {
					// 버튼 클릭 시 해당 카테고리로 메뉴 업데이트
					buttons.forEach(b => b.classList.remove('active'));
					button.classList.add('active');
					
					let category = button.getAttribute('data-category');
					loadMenu(category);  // 메뉴를 로드하는 함수 호출
				});
			});
			
			let btn = document.querySelectorAll('.nav-button');
			btn.forEach(button => {
				button.addEventListener('click', function(){
					btn.forEach(b => b.classList.remove('active'));
					button.classList.add('active');
					
					let category = button.getAttribute('data-category');
					loadMenu(category);
				});
			});
			
			loadMenu();
			
			itemGrid.addEventListener("click", (event) => {
				if(event.target.closest(".menu-item")) {
					const element = event.target.closest(".menu-item");
					let name = element.dataset.name;
					let price = parseInt(element.dataset.price);
		
					// 해당 메뉴가 이미 배열에 있는지 체크
					let existingItem = selectedMenu.find(item => item.name === name);

					if(existingItem) {
						// 이미 있으면 수량 증가
						existingItem.count++;
					} 
					else {
						// 없으면 새로운 항목 추가
						selectedMenu.push({name, price, count: 1});
		            }
		
		            // 배열 전체를 다시 그리기
		            arrayPrint();
				}
			});
			
			// 주문 등록 ( 매출 상세 저장 )
			document.querySelector("#menuSub").addEventListener('click', function(){
				
				let items = document.querySelectorAll("#selected-items .list-group-item");
				let aryMenu = [];
				items.forEach(item => {
						let data = {
							productCode: item.querySelector(".my-0").innerText,
							salePrice: item.querySelector(".pri").innerText.replace(',',''),
							quantity: item.querySelector(".su").innerText.split(" ")[1]
						}
						aryMenu.push(data);
				});
				
				//AJAX			
				fetch("/pos", {
					method: "POST",
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify(aryMenu)
				})
				.then(response => response.text())
				.then(data => {
					alert("주문완료!");
				})
				.catch(error => {
					console.error(error);
					alert("주문실패 ㅜㅜ..");
				});
				selectedMenu = [];
				arrayPrint();
				selectItemList.innerHTML = '';
				
			});
		});
		

		
		
		function arrayPrint() {
		    // 리스트를 비우고
		    selectItemList.innerHTML = '';
		    let totalPrice = 0;

		    // 6개씩 표시
		    let itemsShow = selectedMenu.slice(0, disItemCnt + 6);

		    itemsShow.forEach((item, idx) => {
		        // 숫자 3자리마다 쉼표 추가
		        let priceCom = (item.price * item.count).toLocaleString();
		        // 항목을 HTML로 변환
		        let node = `
		            <li class="list-group-item d-flex justify-content-between lh-sm">
		                <div style="width:50%">
		                    <h6 class="my-0" style="font-size:15px">${item.name}</h6>
		                    <small class="text-body-secondary su">수량: ${item.count} EA</small>
		                    <button class="btn amount" value="plus">+</button>
		                    <button class="btn amount" value="minus">-</button>
		                </div>
		                <span class="text-body-secondary pri">${priceCom}</span>              
		                <button class="btn btn-danger delete-button" data-idx="${idx}" style="height:50px">삭제</button>
		            </li>`;
		        
		        selectItemList.insertAdjacentHTML("beforeend", node);
		        totalPrice += item.price * item.count;
		    });
			// 수량증가 / 감소
			amountBnt();
		    // 총 금액 업데이트
		    totalPriceElem.textContent = `총 금액: ${totalPrice.toLocaleString()}원`;
		    itemCountElem.textContent = `${selectedMenu.length}개`;

		    // 6개 이상이면 더 보여주기
		    if (selectedMenu.length >= disItemCnt + 6) {
		        disItemCnt += 6;
		    }

	        // 총 금액 업데이트
	        totalPriceElem.textContent = `총 금액: ${totalPrice.toLocaleString()}원`;
	        itemCountElem.textContent = `${selectedMenu.length}개`;
	
			// 6개 이상이면 증가
			if(selectedMenu.length >= disItemCnt + 6){
				disItemCnt += 6;
			}
		

			//삭제 이벤트
			let deleteBnt = selectItemList.querySelectorAll('.delete-button');
			deleteBnt.forEach((button) => {
				button.addEventListener('click', function(){
					let idx = button.getAttribute('data-idx');
					deleteItem(idx);
				});
			});
		}

		//항목 삭제 함수
		function deleteItem(idx){
			selectedMenu.splice(idx, 1);
			arrayPrint();
		}
		

		
		// 버튼 클릭시 수량 증가/감수
		function amountBnt() {
		    // 클래스 이름이 'amount'인 버튼들을 불러오기
		    let btns = document.querySelectorAll('.amount');
		
		    btns.forEach(btn => {
		        btn.addEventListener('click', function(event) {
		            // 클릭된 버튼의 가장 가까운 부모 요소
		            let item = event.target.closest('.list-group-item');
		            
		            // id가 cnt인 요소 (수량 표시 부분)
		            let su = item.querySelector('.su');
		            let idx = item.querySelector('.delete-button').getAttribute('data-idx');
		            let selItem = selectedMenu[idx]; // 선택된 메뉴 항목 가져오기
		
		            // 수량 증가 또는 감소
		            if (btn.value === "plus") {
		                selItem.count += 1;  // 수량 증가
		            } else if (btn.value === "minus") {
		                // 최소 수량 1개 유지
		                selItem.count = Math.max(1, selItem.count - 1); 
		            }
		
		            // 수량을 갱신
		            su.textContent = `수량: ${selItem.count} EA`; // 수량 업데이트
		
		            // 총 금액 및 선택된 메뉴 리스트 업데이트
		            arrayPrint(); // 메뉴 전체 갱신
		        });
		    });
		}
		
		// 메뉴를 AJAX로 로드하는 함수
		function loadMenu(category) {
		    // category가 없으면 전체 메뉴를 요청
		    let url = category ? `/pos/menu?category=${category}` : '/pos/menu';
		    
		    // /pos/menu로 변경
		    fetch(url)
		        .then(response => response.json())
		        .then(data => {
		        	menuData = data;
		        	if(Math.ceil(menuData.length / itemsPage) < 1){
		        		totalPages = 1;
		        	}
		        	else{
		        		totalPages = Math.ceil(menuData.length / itemsPage);
		        	}
		        	renderMenu();
		        })
		        .catch(error => {
		            console.error("삐용삐용:", error);
		        });
		}
		
		function renderMenu(){
			// 생지인거 제외
			let filterMenu = menuData.filter((item) => item.sub !== '생지');
			
			let startIndex = (curPage - 1) * itemsPage;
			let endIndex = startIndex + itemsPage;
			
			// 필터링된거 가져오기
			let itemsToDisplay = filterMenu.slice(startIndex, endIndex);
			
			// 내용 초기화
			itemGrid.innerHTML = '';
			
			itemsToDisplay.forEach(item => {
                let node = `
                    <div class="menu-item" data-name="${item.productName}" data-price="${item.salePrice}" data-code="${item.productCode}" style="font-size:15px">
                        <div class="item-name">${item.productName}</div>
                        <div class="item-price">${item.salePrice}</div>
                    </div>
                `;
                itemGrid.insertAdjacentHTML('beforeend', node);
			});
			
			//페이지 번호 업데이트
			updatePagination();
		}
		
		function updatePagination(){
			let pagination = document.querySelector('.pagination');
			pagination.innerHTML = '';
			
			let prevBtn = document.createElement('button');
			prevBtn.textContent = '◀';
			prevBtn.disabled = curPage == 1;
			prevBtn.classList.add("action-button");
			prevBtn.addEventListener('click', () => changePage(curPage -1));
			pagination.appendChild(prevBtn);
			
			let pageNum = document.createElement('span');
			pageNum.textContent = `${curPage} / ${totalPages}`;				
			pagination.appendChild(pageNum);
			
			let nextBtn = document.createElement('button');
			nextBtn.textContent = '▶';
			nextBtn.classList.add("action-button");
			nextBtn.disabled = curPage == totalPages;
			nextBtn.addEventListener('click', () => changePage(curPage + 1));
			pagination.appendChild(nextBtn);
			
		}
		
		function changePage(page){
			if(page < 1 || page > totalPages) return;
			curPage = page;
			renderMenu();
		}

		document.getElementById("salesSub").addEventListener('click', function(){
			let url = `/closeSale`
			fetch(url)
			.then(res => res.text())
			.then(date => {
				alert("마감정산 완료!");
			})
		})
		
		// 모달창 열고 닫기
		document.querySelector(".details-button").addEventListener("click", function() {
	        openModal();
	    });

	    function openModal() {
	        let modal = document.getElementById("detailsModal");
	        modal.style.display = "block";
	    }

	    function closeModal() {
	        let modal = document.getElementById("detailsModal");
	        modal.style.display = "none";
	    }

	    document.querySelector(".close-button").addEventListener("click", closeModal);
		    window.addEventListener("click", function(event) {
		        let modal = document.getElementById("detailsModal");
		        if (event.target === modal) {
		            closeModal();
		        }
	    });

    </script>
</body>
</html>
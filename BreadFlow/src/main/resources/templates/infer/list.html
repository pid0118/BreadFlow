<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org/"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="~{common/layouts/breadflow_layout}"
	  layout:fragment="Content">
<head>
<meta charset="UTF-8">
<title>불량 내역 조회</title>
</head>
<body>
	<div class="card-box mb-30">
		<div class="pd-20">
			<h2 class="text-black">불량 내역</h2>
		</div>
		<div>
			<input class="form-control" type="text" name="companyInput" id="companyInput" th:value="${session.companyName}" style=display:none; readonly>
			<input class="form-control" type="text" name="companyDiv" id="companyDiv" th:value="${session.div}" style=display:none; readonly>
			<div class="btn-group btn-group-toggle pd-20" data-toggle="buttons">
				<label class="btn btn-outline-secondary active">
					<input type="radio" name="options" value="전체" id="seeAll" autocomplete="off" checked>전체
				</label>
				<label class="btn btn-outline-secondary">
					<input type="radio" name="options" value="미확인" id="seeUnchecked" autocomplete="off">미확인
				</label>
				<label class="btn btn-outline-secondary">
					<input type="radio" name="options" value="확인" id="seeChecked" autocomplete="off">확인
				</label>
			</div>
		</div>
		<div class="pd-20">
  			<button type="button" class="dropdown btn btn-primary dropdown-toggle" id="yearlyBtn" data-bs-toggle="dropdown" aria-expanded="false">연도</button>
			<ul class="dropdown-menu" id="yearlyMenu">
				<li th:each="num : ${#numbers.sequence(localDateTime-10, localDateTime)}">
                    <a class="dropdown-item year">[[ ${num} ]]</a>
                </li>
			</ul>
  			<button type="button" class="dropdown btn btn-primary dropdown-toggle" id="monthlyBtn" data-bs-toggle="dropdown" aria-expanded="false">월</button>
			<ul class="dropdown-menu" id="monthlyMenu">
 				<li th:each="num : ${#numbers.sequence(1,12)}"><a class="dropdown-item month">[[ ${num} ]]</a></li>
            </ul>
            <button type="button" class="dropdown btn btn-primary dropdown-toggle" id="confirmCompBtn" data-bs-toggle="dropdown" aria-expanded="false">확인 위치</button>
			<ul class="dropdown-menu" id="companyMenu">
 				<li th:each="company : ${companyList}">
                    <a class="dropdown-item company">[[ ${company.companyName} ]]</a>
                </li>
            </ul>
            <button type="button" class="dropdown btn btn-primary dropdown-toggle" id="disposalBtn" data-bs-toggle="dropdown" aria-expanded="false">확인 위치</button>
			<ul class="dropdown-menu" id="disposal">
 				<li class="dropdown-item disposal" value="i1">반품</li>
 				<li class="dropdown-item disposal" value="i2">폐기</li>
 				<li class="dropdown-item disposal" value="i3">철회</li>
            </ul>
		</div>
		<div class="pd-20 input-group mb-3">
			<input class="form-control" type="text" id="searchKeyword">
			<button type="button" class="btn btn-primary" id="searchBtn">검색</button>
		</div>
		<div class="pd-20 input-group">
			<input class="form-control" type="date" id="startDate">
			<input class="form-control" type="date" id="endDate">
			<button type="button" class="btn btn-primary input-group-button" id="dateFilterBtn">검색</button>
		</div>
		<div class="pd-20">
			<table class="data-table table stripe hover multiple-select-row nowrap" id="inferTable">
				<thead>
					<tr id="inferHistoryHead">
						<th class="table-plus">불량 입력 일자</th>
						<th class="datatable-nosort">확인 위치</th>
						<th class="datatable-nosort">품목</th>
						<th>수량</th>
						<th class="datatable-nosort">처분</th>
						<th class="datatable-nosort">확인 여부</th>
					</tr>
				</thead>
				<tbody id="inferHistoryTable">

				</tbody>
			</table>
		</div>
	</div>
	
    <script>
	 	// 조건
	 	var companyInput = null;
	 	var div = null;
	 	var clearTable = null;
		var year = null;
		var month = null;
		var disposal = null;
		var checked = null;
		var unchecked = null;
		var confirmComp = null;
		var startDt = null;
		var endDt = null;
   	
        $(document).ready(function() {
        	
        	// 로그인한 업체 이름 저장
        	companyInput = $("#companyInput").val();
        	
        	// 로그인한 업체 코드 저장
        	div = $("#companyDiv").val();

            // 기본 내역 출력
            changeFilter();
            
            function clear() {
            	clearTable = null;
    			year = null;
    			month = null;
    			disposal = null;
    			checked = null;
    			unchecked =  null;
    			confirmComp = null;
    			startDt = null;
    			endDt = null;
            }
            
            function confirmExClear() {
    			year = null;
    			month = null;
    			disposal = null;
    			confirmComp = null;
    			startDt = null;
    			endDt = null;
            }
            
            if (div !== '본사') {
            	$("#confirmCompBtn").css("display", "none");
            	$("#inferHistoryHead").append("<th>답변 일자</th>");
            }
            
            // 전체 내역 버튼 클릭
            $("#seeAll").click(function() {
            	$("#yearlyBtn").text('연도');
            	$("#monthlyBtn").text('월');
            	$("#confirmCompBtn").text('확인 위치');
            	clear();
            	changeFilter();
            });
            
            // 미확인 내역 버튼 클릭
            $("#seeUnchecked").click(function() {
            	$("#yearlyBtn").text('연도');
            	$("#monthlyBtn").text('월');
            	$("#confirmCompBtn").text('확인 위치');
            	unchecked = '미확인';
            	checked = null;
            	clearTable = 'notClear';
            	confirmExClear();
            	changeFilter();
            });

            // 확인 내역 버튼 클릭
            $("#seeChecked").click(function() {
            	$("#yearlyBtn").text('연도');
            	$("#monthlyBtn").text('월');
            	$("#confirmCompBtn").text('확인 위치');
            	checked = '확인';
            	unchecked = null;
            	clearTable = 'notClear';
            	confirmExClear();
            	changeFilter();
            });

            // 연도별 필터 클릭
            $(document).on('click', '.year', function() {
                year = $(this).text().trim();
                clearTable = 'notClear';
                $("#yearlyBtn").text(year);
                changeFilter();
            });

            // 월별 필터 클릭
            $(document).on('click', '.month', function() {
                month = $(this).text().trim();
                clearTable = 'notClear';
                $("#monthlyBtn").text(month);
                changeFilter();
            });
            
            // 확인 위치별 필터 클릭
            $(document).on('click', '.company', function() {
                confirmComp = $(this).text().trim();
                clearTable = 'notClear';
                $("#confirmCompBtn").text(confirmComp);
                changeFilter();
            });
            
        	// 처분별 필터 클릭
            $(document).on('click', '.disposal', function() {
                disposal = $(this).text().trim();
                clearTable = 'notClear';
                $("#disposalBtn").text(disposal);
                changeFilter();
            });
            
            // 입력시 검색
            $("#searchKeyword").on('input', function() {
    	        var keyword = $(this).val().toLowerCase();
    	        searchData(keyword);
    	    });

            // 검색 버튼 클릭
            $("#searchBtn").click(function() {
                var keyword = $("#searchKeyword").val().toLowerCase();
                searchData(keyword);
            });

            // 날짜 필터 버튼 클릭
            $("#dateFilterBtn").click(function() {
                startDt = $("#startDate").val();
                endDt = $("#endDate").val();
                clearTable = 'notClear';
                changeFilter();
            });

        });
        
        // 필터값 전송
        function changeFilter() {
        	$.ajax({
            	url : '/infer/getInferList',
            	method : 'GET',
            	data : {companyInput,
            			clearTable,
            			year,
            			month,
            			disposal,
            			checked,
            			unchecked,
            			confirmComp,
            			div,
            			startDt,
            			endDt},
            	success : function(data) {
            		updateTable(data);
            		console.log(data);
            	},
            	error : function() {
	                alert("내역을 불러오는 데 실패했습니다.");
	            }
            });
        }

        // 목록 갱신
        function updateTable(data) {
            var tbody = $("#inferHistoryTable");
            tbody.empty();
            data.forEach(function(item) {
                var row = null;
                	if (div !== '본사') {
                		row += "<tr onclick='window.location = \"/inferListDetail/" + item.inferNo + "\"'>";
                	} else {
                		row += "<tr onclick='window.location = \"/inferAnswerInsert/" + item.inferNo + "\"'>";
                	}
                	row += "<td style='display:none;'>" + item.inferNo + "</td>";
                    row += "<td class='table-plus date'>" + item.inferApplicationDate + "</td>";
                    row += "<td>" + item.confirmLocation + "</td>";
                    row += "<td>" + item.inferItem + "</td>";
                    row += "<td>" + item.inferQuantity + "</td>";
                    row += "<td>" + item.disposalWhether + "</td>";
                    row += "<td>" + item.confirmWhether + "</td>";
                    if (div !== '본사') {
                    	if (item.answerDate != null) {
                    		row += "<td>" + item.answerDate + "</td>";
                    	} else {
                    		row += "<td>답변 대기중</td>";
                    	}
                    }
                	row += "</tr>";
                tbody.append(row);
            });
        }
        
        // 검색
        function searchData(keyword) {
            $("#inferHistoryTable tr").each(function() {
                var rowText = $(this).text().toLowerCase();
                if (rowText.includes(keyword)) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        }

    </script>
</body>
</html>